/*
===========================================
load script-silver table 'crm_sales_details'
===========================================
script purpose: cleaning the data from the bronze layer table and loading it to the silver layer table after truncating the old silver layer table
===========================================
*/

truncate table silver.crm_sales_details
insert into silver.crm_sales_details(
	sls_ord_num,
	sls_prd_key,
	sls_cust_id,
	sls_order_dt,
	sls_ship_dt,
	sls_due_dt,
	sls_sales,
	sls_quantity,
	sls_price )

select 
sls_ord_num,
sls_prd_key,
sls_cust_id,
case 
when len(sls_order_dt)!=8 or sls_order_dt=0 then null 
else cast(cast(sls_order_dt as varchar) as date)
end as sls_order_dt, --Convert into valid date and remove unreasonable numbers
case 
when len(sls_ship_dt)!=8 or sls_ship_dt=0 then null 
else cast(cast(sls_ship_dt as varchar) as date)
end as sls_ship_dt, --Convert into valid date and remove unreasonable numbers
case
when len(sls_due_dt)!=8 or sls_due_dt=0 then null 
else cast(cast(sls_due_dt as varchar) as date)
end as sls_due_dt, --Convert into valid date and remove unreasonable numbers
case
when sls_sales<=0 or sls_sales is null or sls_sales!=ABS(sls_price)*sls_quantity 
then ABS(sls_price)*sls_quantity 
else sls_sales
end as sls_sales, --fix to a logically correct number
sls_quantity,
case 
when sls_price is null or sls_price<=0
then sls_sales/ nullif( sls_quantity,0)
else sls_price
end as sls_price --fix to a logically correct number
from bronze.crm_sales_details
